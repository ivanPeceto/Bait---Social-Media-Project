<div class="flex justify-center items-center p-4 sticky top-14 z-10 bg-gray-900 border-b border-gray-700">
  <div class="relative w-full max-w-lg">
    <input
      type="text"
      placeholder="Buscar en Bait (ej: juan o @admin)"
      class="bg-gray-700 text-white w-full px-3 py-1.5 text-sm rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
      [formControl]="searchControl"
      (focus)="showResults = true"
      (keydown.escape)="clearSearch()"
    />
    <div *ngIf="showResults && searchControl.value" class="absolute mt-2 w-full bg-gray-800 rounded-md shadow-lg z-30 border border-gray-700 max-h-80 overflow-y-auto">
      <div *ngIf="isSearching" class="px-4 py-3 text-sm text-gray-400">Buscando...</div>
      <div *ngIf="!isSearching">
        <ul *ngIf="searchResults.length > 0; else noResults">
          <li *ngFor="let user of searchResults" (click)="goToProfile(user.username)" class="cursor-pointer">
            <div class="flex items-center px-4 py-3 hover:bg-gray-700 transition-colors">
              <img class="w-10 h-10 rounded-full mr-3"
                   [src]="user.avatar?.url_avatars ? (user.avatar?.url_avatars | mediaUrl) : 'assets/images/iconousuario.png'"
                   alt="Avatar de {{ user.name }}">
              <div>
                <p class="font-semibold text-sm text-white">{{ user.name }}</p>
                <p class="text-xs text-gray-400">@{{ user.username }}</p>
              </div>
            </div>
          </li>
        </ul>
        <ng-template #noResults>
          <div class="px-4 py-3 text-sm text-gray-400">No se encontraron resultados para "{{ searchControl.value }}".</div>
        </ng-template>
      </div>
    </div>
  </div>
</div>

<div class="p-4 border-b border-gray-700 mt-8">
  <form [formGroup]="postForm" (ngSubmit)="onPostSubmit()">
    <div class="relative">
      <textarea
        formControlName="content_posts"
        class="bg-transparent text-lg w-full p-2 text-gray-200 focus:outline-none resize-none pr-24 pb-24"
        rows="3"
        placeholder="¿Qué estás pensando, {{ currentUser?.name }}?"
      ></textarea>
      <div *ngIf="previewUrl" class="absolute bottom-2 right-2 border border-gray-700 rounded-md overflow-hidden bg-black/30">
        <img [src]="previewUrl" alt="Previsualización" class="max-h-20 max-w-[6rem] object-cover block">
        <button type="button" (click)="onRemoveSelectedImage()" class="absolute -top-2 -right-2 bg-black/70 hover:bg-black/90 text-white p-1 rounded-full" title="Quitar imagen">
          <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
    </div>
    <div *ngIf="postForm.get('content_posts')?.invalid && (postForm.get('content_posts')?.dirty || postForm.get('content_posts')?.touched)" class="text-red-500 text-sm mt-1">
      <div *ngIf="postForm.get('content_posts')?.errors?.['required']">El contenido no puede estar vacío.</div>
      <div *ngIf="postForm.get('content_posts')?.errors?.['maxlength']">La publicación no puede exceder los 280 caracteres.</div>
    </div>
    <div *ngIf="apiErrors?.content_posts" class="text-red-500 text-sm mt-1">
      <span *ngFor="let error of apiErrors.content_posts">{{ error }}</span>
    </div>
    <div *ngIf="apiErrors?.general" class="text-red-500 text-sm mt-1">
      <span *ngFor="let error of apiErrors.general">{{ error }}</span>
    </div>
    <div class="flex justify-between items-end mt-2 pt-3">
      <div class="flex items-center gap-2">
        <input id="composerImageInput" #composerImageInput type="file" accept="image/*" class="hidden" (change)="onSelectImage($event)">
        <label for="composerImageInput" title="Subir imagen" class="text-blue-500 hover:text-blue-400 p-2 rounded-full transition-colors cursor-pointer inline-flex">
          <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
        </label>
        <span *ngIf="isUploadingMedia" class="text-xs text-gray-400">Subiendo imagen...</span>
      </div>
      <button type="submit" [disabled]="postForm.invalid || isUploadingMedia" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-md disabled:bg-blue-800 disabled:opacity-70 disabled:cursor-not-allowed hover:bg-blue-600 transition-colors">
        {{ isUploadingMedia ? 'Publicando…' : 'Postear' }}
      </button>
    </div>

    
  </form>
</div>

<div class="divide-y divide-gray-700">

  <ng-container *ngFor="let item of posts">
    
    <div [ngSwitch]="item.type">

      <div *ngSwitchCase="'repost'" class="p-4 transition-colors duration-150">
        <div class="flex items-center space-x-2 text-sm text-gray-500 mb-2 pl-5">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
          <a [routerLink]="['/profile', item.user?.username]" class="font-semibold hover:underline">
            {{ item.user?.id === currentUser?.id ? 'Tú' : (item.user?.name || 'Alguien') }} reposteó
          </a>
        </div>
        
        <ng-container *ngTemplateOutlet="postTemplate; context: { $implicit: asRepost(item).post }"></ng-container>
      </div>

      <div *ngSwitchCase="'post'" class="p-4 transition-colors duration-150">
        <ng-container *ngTemplateOutlet="postTemplate; context: { $implicit: item }"></ng-container>
      </div>

    </div>
  </ng-container>

  <div *ngIf="posts.length === 0 && !isLoading" class="text-center text-gray-500 mt-8 p-4">
    <p>No hay publicaciones para mostrar.</p>
    <p>¡Sigue a otros usuarios o escribe tu primera publicación!</p>
  </div>
</div>
<ng-template #postTemplate let-post>
  
  <div class="flex justify-between">
    <div class="flex items-center space-x-3">
        <img class="w-10 h-10 rounded-full flex-shrink-0"
             [src]="(post.user?.avatar?.url_avatars | mediaUrl:cacheBustTs) || 'assets/images/iconousuario.png'"
             alt="Avatar de {{ post.user?.name || 'Usuario' }}">
        <div>
          <a [routerLink]="['/profile', post.user?.username]" class="font-semibold text-sm hover:underline text-white">{{ post.user?.name || 'Usuario' }}</a>
          <span class="text-sm text-gray-400 ml-1">@{{ post.user?.username || 'usuario' }}</span>
          <span class="text-sm text-gray-500 ml-2">· {{ post.created_at | date:'short' }}</span>
        </div>
    </div>
    <div *ngIf="currentUser && (currentUser.id === post.user_id || (currentUser.role?.toLowerCase() === 'admin' || currentUser.role?.toLowerCase() === 'moderator'))" class="relative">
        <button (click)="togglePostMenu(post.id)" class="text-gray-400 hover:text-white p-1 rounded-full transition-colors">
            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Zm0 6a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Zm0 6a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z" /></svg>
        </button>
        <div *ngIf="openPostId === post.id" class="absolute right-0 mt-1 w-32 bg-gray-800 rounded-lg shadow-lg border border-gray-700 z-20">
            <ul class="py-1">
              <li *ngIf="currentUser?.id === post.user_id">
                <button (click)="startEditPost(post)" class="w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-700">Editar</button>
              </li>
              <li>
                <button (click)="onDeletePost(post)" class="w-full text-left px-4 py-2 text-sm text-red-500 hover:bg-gray-700">Eliminar</button>
              </li>
            </ul>
        </div>
    </div>
  </div>

  <div *ngIf="editingPostId === post.id; else viewPostContent">
    <textarea class="w-full bg-gray-800 text-gray-100 rounded p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
              rows="3"
              [value]="editContent"
              (input)="editContent = $any($event.target).value"></textarea>
    <div class="mt-2 flex gap-2">
      <button (click)="saveEditPost(post)" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1 rounded">Guardar</button>
      <button (click)="cancelEditPost()" class="border border-gray-600 text-white text-sm px-3 py-1 rounded hover:bg-gray-800">Cancelar</button>
    </div>
  </div>
  <ng-template #viewPostContent>
    <p class="mt-3 text-sm whitespace-pre-wrap text-gray-200">{{ post.content_posts }}</p>
  </ng-template>

  <div *ngIf="post.multimedia_contents && post.multimedia_contents.length > 0" class="mt-3">
      <img [src]="post.multimedia_contents[0].url_content | mediaUrl:cacheBustTs" alt="Imagen del post" class="max-h-96 rounded-lg border border-gray-700">
  </div>

  <div class="flex justify-around mt-4 text-gray-500">
    <button (click)="openComments(post)" class="flex items-center space-x-1 group focus:outline-none">
      <div class="p-2 rounded-full group-hover:bg-blue-500/10 transition-colors"><svg class="w-5 h-5 group-hover:text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18zM18 14H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg></div>
      <span class="text-xs group-hover:text-blue-500">{{ post.comments_count || 0 }}</span>
    </button>
    <button (click)="onToggleRepost(post)" class="flex items-center space-x-1 group focus:outline-none">
      <div class="p-2 rounded-full group-hover:bg-green-500/10 transition-colors"><svg class="w-5 h-5 group-hover:text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg></div>
      <span class="text-xs group-hover:text-green-500">{{ post.reposts_count || 0 }}</span>
    </button>
    <button (click)="onToggleLike(post)" class="flex items-center space-x-1 group focus:outline-none" [class.text-blue-500]="post.is_liked_by_user">
      <div class="p-2 rounded-full group-hover:bg-blue-500/10 transition-colors"><svg class="w-5 h-5" [class.fill-blue-500]="post.is_liked_by_user" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg></div>
      <span class="text-xs">{{ post.reactions_count || 0 }}</span>
    </button>
  </div>
    <app-post-comments-section
    *ngIf="openCommentPostId === post.id"
    [post]="post"
    (commentAdded)="onCommentAdded()"
    (commentDeleted)="onCommentDeleted()"
  ></app-post-comments-section>
</ng-template>