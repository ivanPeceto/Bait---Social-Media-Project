<ng-container *ngIf="userProfile$ | async as user; else loading">
  <div class="profile-page">

    <a routerLink="/" class="home-link inline-block p-4 absolute top-0 left-0 z-10">
      <img
        class="arrow-icon h-6 w-6 text-white filter drop-shadow(0 1px 1px rgba(0,0,0,0.7))" src="assets/images/arrow-left-solid-full.svg"
        alt="Volver al Home">
    </a>

    <div class="profile-header-container border-b border-gray-700 pb-4"> <div class="profile-banner relative">
         <img *ngIf="bannerPreviewUrl"
              [src]="bannerPreviewUrl"
              alt="Previsualización Banner"
              class="w-full h-48 object-cover">
         <img *ngIf="!bannerPreviewUrl"
              [src]="(user.banner ? (apiUrlForImages + user.banner.url_banners) : 'assets/images/images.png')"
              alt="Banner de {{ user.name }}"
              class="w-full h-48 object-cover">

        <label *ngIf="isOwnProfile && !selectedBannerFile && !isUploadingBanner"
               for="bannerInput"
               class="absolute inset-0 bg-black bg-opacity-30 flex items-center justify-center opacity-0 hover:opacity-100 cursor-pointer transition-opacity group">
          <div class="text-center">
             <svg class="w-8 h-8 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" /> <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" /> </svg>
             <span class="mt-1 text-white text-sm font-semibold block">Cambiar Banner</span>
          </div>
        </label>
         <div *ngIf="isUploadingBanner" class="absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center"> <p class="text-white animate-pulse">Subiendo...</p> </div>

          <div *ngIf="selectedBannerFile && !isUploadingBanner && isOwnProfile"
               class="absolute bottom-2 right-2 z-10 space-x-2">
                 <button (click)="onUploadBanner()"
                         class="bg-green-600 hover:bg-green-700 text-white text-xs py-1 px-3 rounded shadow transition-colors"> Confirmar Banner </button>
                 <button (click)="cancelBannerChange()"
                         class="bg-red-600 hover:bg-red-700 text-white text-xs py-1 px-3 rounded shadow transition-colors"> Cancelar </button>
          </div>
      </div> <div class="px-4 relative">
        <div class="profile-avatar relative w-24 h-24 rounded-full overflow-hidden border-4 border-gray-900 -mt-12 z-10">
           <img *ngIf="avatarPreviewUrl" [src]="avatarPreviewUrl" alt="Previsualización Avatar" class="w-full h-full object-cover">
           <img *ngIf="!avatarPreviewUrl" [src]="(user.avatar ? (apiUrlForImages + user.avatar.url_avatars) : 'assets/images/iconousuario.png')" alt="Avatar de {{ user.name }}" class="w-full h-full object-cover">
           <label *ngIf="isOwnProfile && !selectedAvatarFile && !isUploadingAvatar" for="avatarInput" class="absolute inset-0 bg-black bg-opacity-30 rounded-full flex items-center justify-center opacity-0 hover:opacity-100 cursor-pointer transition-opacity group">
               <svg class="w-6 h-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" /> <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" /> </svg>
           </label>
            <div *ngIf="isUploadingAvatar" class="absolute inset-0 bg-black bg-opacity-70 rounded-full flex items-center justify-center"> <p class="text-white text-xs animate-pulse">Subiendo...</p> </div>
        </div>

        <div class="profile-actions absolute top-0 right-4 mt-20" *ngIf="isOwnProfile"> <button class="btn btn-edit bg-gray-900 border border-gray-700 text-white py-0.5 px-3 rounded-full text-sm hover:bg-gray-700">Editar Perfil</button>
        </div>
        <div class="mt-2">
           <h2 class="name text-xl font-bold">{{ user.name }}</h2>
           <p class="username text-sm text-gray-400">@{{ user.username }}</p>

           <p class="joined-date text-sm text-gray-500 mt-1">
             <svg class="inline-block w-4 h-4 mr-1 align-text-bottom" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5m-9-6h.008v.008H12v-.008zM12 15h.008v.008H12V15zm0 2.25h.008v.008H12v-.008zM9.75 15h.008v.008H9.75V15zm0 2.25h.008v.008H9.75v-.008zM7.5 15h.008v.008H7.5V15zm0 2.25h.008v.008H7.5v-.008zm6.75-4.5h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V15zm0 2.25h.008v.008h-.008v-.008zm2.25-4.5h.008v.008H16.5v-.008zm0 2.25h.008v.008H16.5V15z" /> </svg>
             Unido a Bait en {{ user.created_at | date:'MMMM yyyy' }}
           </p>
           
           <div *ngIf="selectedAvatarFile && !isUploadingAvatar && isOwnProfile" class="mt-2 space-x-2">
                 <button (click)="onUploadAvatar()" class="bg-green-600 hover:bg-green-700 text-white text-xs py-1 px-3 rounded transition-colors"> Confirmar Avatar </button>
                 <button (click)="cancelAvatarChange()" class="bg-red-600 hover:bg-red-700 text-white text-xs py-1 px-3 rounded transition-colors"> Cancelar </button>
           </div>
        </div>

        </div> </div> <input *ngIf="isOwnProfile" type="file" id="avatarInput" accept="image/*" (change)="onAvatarSelected($event)" class="hidden">
    <input *ngIf="isOwnProfile" type="file" id="bannerInput" accept="image/*" (change)="onBannerSelected($event)" class="hidden">

    <div class="divide-y divide-gray-700">

      <div *ngFor="let post of userPosts" class="p-4">
        <div class="flex justify-between">
          <div class="flex items-center space-x-3">
              <img class="w-10 h-10 rounded-full"
                   [src]="(user.avatar ? (apiUrlForImages + user.avatar.url_avatars) : 'assets/images/iconousuario.png')"
                   alt="Avatar de {{ user.name }}">
              <div>
                  <span class="font-semibold text-sm">{{ user.name }}</span>
                  <span class="text-sm text-gray-400 ml-1">@{{ user.username }}</span>
                  <span class="text-sm text-gray-500 ml-2">· {{ post.created_at | date:'short' }}</span>
              </div>
          </div>

          <div *ngIf="isOwnProfile" class="relative">
              <button (click)="togglePostMenu(post.id)" class="text-gray-400 hover:text-white p-1 rounded-full transition-colors"> <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Zm0 6a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Zm0 6a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z" /> </svg> </button>
              <div *ngIf="openPostId === post.id" class="absolute bottom-full right-0 z-10 mb-1 w-28 bg-gray-800 rounded-lg shadow-lg border border-gray-700"> <ul class="py-1"> <li> <button (click)="onDeletePost(post.id)" class="w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-700"> Eliminar </button> </li> </ul> </div>
          </div>
        </div>

        <p class="mt-3 text-sm whitespace-pre-wrap">{{ post.content_posts }}</p>

        <div *ngIf="post.multimedia_contents && post.multimedia_contents.length > 0" class="mt-3">
            <img [src]="apiUrlForImages + post.multimedia_contents[0].url_content" alt="Imagen del post" class="max-h-96 rounded-lg border border-gray-700">
            </div>

      </div>
      <div *ngIf="!userPosts || userPosts.length === 0" class="p-4 text-center text-gray-500"> <p>Este usuario aún no ha posteado nada.</p> </div>

    </div> </div> </ng-container>

<ng-template #loading>
  <p class="p-4 text-center">Cargando perfil...</p>
</ng-template>